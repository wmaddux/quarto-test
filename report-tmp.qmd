---
title: "Aerospike Health and Performance Report"
author: "Aerospike TAM Team"
format: 
  html:
    self-contained: true
    code-tools: false    # This removes the "Code" dropdown button
    code-fold: false      # This ensures no code is hidden behind toggles
execute:
  echo: false            # This hides code for ALL cells by default
---

```python
#| output: false
import sqlite3
import pandas as pd
import plotly.express as px
import os
import datetime
from IPython.display import display, Markdown, HTML
import sys

# --- Import Rules ---
from rules import (
    error_skew_check, 
    version_consistency_check,
    network_acceleration_check,
    deadlock_check,
    sindex_check,
    sprigs_check,
    hwm_check,
    memory_hwm_check,
    config_symmetry_check,
    config_drift_check,
    hot_key_check,
    read_not_found_check,
    delete_not_found_check,
    set_object_skew_check,
    capacity_check,
    security_connection_audit
)

# --- Baseline Metadata ---
PROJECT_VERSION = "1.6.0"
GEN_DATE = datetime.datetime.now().strftime("%Y-%m-%d %H:%M")
db_path = "aerospike_health.db"

# --- 1. Data Retrieval & Metadata ---
cluster_display = "Unnamed Cluster"
server_version = "Unknown"
node_count = 0
feature_list = []
active_features_str = "None detected"
cloud_platform = "Unknown"
consistency = "Unknown"
storage = "Unknown"
idx_type = "Unknown"
topology = "Unknown"

if os.path.exists(db_path):
    conn = sqlite3.connect(db_path)
    try:  # Added missing try block
        meta_df = pd.read_sql_query("SELECT * FROM cluster_metadata", conn)
        metadata = dict(zip(meta_df['key'], meta_df['value']))

        # Extract the config flavors
        cluster_display = metadata.get('cluster_name', "Unnamed Cluster")
        cloud_platform = metadata.get('cloud_platform', "Unknown")
        server_version = metadata.get('server_version', "Unknown")
        consistency = metadata.get('consistency_model', "Unknown")
        storage = metadata.get('storage_flavor', "Unknown")
        idx_type = metadata.get('index_flavor', "Unknown")
        topology = metadata.get('topology', "Unknown")
        
        # Node Count (Fixed Indentation)
        node_res = pd.read_sql_query("SELECT COUNT(DISTINCT node_id) as count FROM node_stats", conn)
        node_count = node_res['count'].iloc[0] if not node_res.empty else 0

        # Feature Discovery (Fixed Indentation)
        features_df = pd.read_sql_query("SELECT DISTINCT feature FROM active_features", conn)
        feature_list = sorted(features_df['feature'].tolist())
        active_features_str = ", ".join(feature_list) if feature_list else "None detected"

    except Exception as e:
        print(f"Error during metadata retrieval: {e}")
    finally:
        conn.close()

# --- 2. Execute Ruleset ---
results = [
    error_skew_check.run_check(),
    version_consistency_check.run_check(),
    network_acceleration_check.run_check(),
    deadlock_check.run_check(),
    sindex_check.run_check(),
    sprigs_check.run_check(),
    hwm_check.run_check(),
    memory_hwm_check.run_check(),
    config_symmetry_check.run_check(),
    config_drift_check.run_check(),
    hot_key_check.run_check(),
    read_not_found_check.run_check(),
    delete_not_found_check.run_check(),
    set_object_skew_check.run_check(),
    capacity_check.run_check(),
    security_connection_audit.run_check()
]

# Write to stderr so it shows in the VS Code log but stays out of the HTML report
print(f"\n--- Processed {len(results)} Rules ---", file=sys.stderr)
for r in results:
    print(f"[{r['status']}] {r['id']} {r['name']}: {r['message']}", file=sys.stderr)

# --- 3. Dynamic Narrative Generation ---
crit_count = len([r for r in results if r['status'] == 'CRITICAL'])
warn_count = len([r for r in results if r['status'] == 'WARNING'])

if crit_count > 0:
    cluster_assessment = f"‚ö†Ô∏è This cluster requires **immediate intervention**. {crit_count} critical issues were detected."
elif warn_count > 3:
    cluster_assessment = f"‚ö° The cluster is stable but showing signs of **resource pressure**. {warn_count} warnings suggest optimization is required."
else:
    cluster_assessment = "‚úÖ The cluster is currently **healthy and operating within optimal parameters**."

is_sc = "Strong Consistency" in consistency
mode_name = "Strong Consistency (SC) deployment" if is_sc else "Available/Partition-tolerant (AP) deployment"
priority_text = "partition safety and transaction integrity" if is_sc else "throughput efficiency and resource headroom"

summary_narrative = (
    f"This diagnostic evaluates the **{cluster_display}** environment, currently running Aerospike **{server_version}** "
    f"across a **{node_count}-node** footprint. Optimized as an **{mode_name}**, the findings below prioritize "
    f"{priority_text}."
)

if topology == "XDR Enabled":
    summary_narrative += " Cross-Datacenter Replication (XDR) is active, adding requirements for inter-cluster bandwidth monitoring."
```

```python
#| label: dynamic-header
#| echo: false
#| output: asis

# A. Determine Consistency Mode for narrative
is_sc = "Strong Consistency" in consistency
mode_name = "Strong Consistency (SC) deployment" if is_sc else "Available/Partition-tolerant (AP) deployment"
priority_text = "partition safety and transaction integrity" if is_sc else "throughput efficiency and resource headroom"

# B. Build the Executive Summary
summary_narrative = (
    f"This diagnostic evaluates the **{cluster_display}** environment, currently running Aerospike **{server_version}** "
    f"across a **{node_count}-node** footprint. Optimized as a **{mode_name}**, the findings below prioritize "
    f"{priority_text}."
)

# C. Append XDR context if detected
if topology == "XDR Enabled":
    summary_narrative += " Cross-Datacenter Replication (XDR) is active, adding requirements for inter-cluster bandwidth monitoring."

# D. Final Markdown Assembly
header_md = f"""
# Aerospike Cluster Health Assessment

{cluster_assessment}

---

## Executive Summary

{summary_narrative}

### Cluster Context
| Attribute | Value |
| :--- | :--- |
| **Cluster Name** | {cluster_display} |
| **Server Version** | {server_version} |
| **Cloud Platform** | {cloud_platform} |
| **Node Count** | {node_count} |
| **Consistency Model**| {consistency} |
| **Storage Engine** | {storage} |
| **Index Location** | {idx_type} |
| **Topology** | {topology} |
| **Active Features** | {active_features_str} |

::: {{.callout-note collapse="true"}}
## Why this context matters
The active features detected (such as SC, Rack-awareness, or XDR) fundamentally change how Aerospike handles data distribution and consistency. This report tailors its health checks based on the specific architectural flags identified during ingestion.
:::

::: {{.callout-note}}
## TAM Assessment Scope
Findings are based on a point-in-time snapshot. Remediation should be tested in a staging environment before production deployment.
:::
"""

display(Markdown(header_md))
```

## Cluster Status Overview
```python
#| label: cluster-overview
#| echo: false
#| output: asis

for res in results:
    if res['status'] in ['CRITICAL', 'WARNING']:
        status_style = "danger" if res['status'] == "CRITICAL" else "warning"
        display(Markdown(f"::: {{.callout-{status_style}}}\n## {res['name']}\n{res['message']}\n:::\n"))
```

# Performance and Utilization

## Disk Usage % by Node
```python
#| label: disk-chart
#| echo: false
if os.path.exists(db_path):
    conn = sqlite3.connect(db_path)
    query = """
        SELECT node_id, namespace, MAX(value) as used_pct 
        FROM namespace_stats 
        WHERE metric = 'service.data_used_pct' 
        GROUP BY node_id, namespace
    """
    df_disk = pd.read_sql_query(query, conn)
    conn.close()

    if not df_disk.empty:
        fig = px.bar(df_disk, x="node_id", y="used_pct", color="namespace", barmode="group", title="Disk Usage % by Node")
        
        # VISUAL FIX: Move legend to bottom
        fig.update_layout(
            xaxis_tickangle=-45,
            legend=dict(
                orientation="h",
                yanchor="bottom",
                y=-0.3,
                xanchor="center",
                x=0.5
            )
        )
        
        fig.add_hline(y=60, line_dash="dot", line_color="red", annotation_text="HWM (60%)")
        fig.show()
```

## Client Connections
```python
#| label: connections-chart
#| echo: false
if os.path.exists(db_path):
    conn = sqlite3.connect(db_path)
    # Using the service. prefix created by our 7.x modular ingestor
    query = "SELECT node_id, value FROM node_stats WHERE metric = 'service.client_connections'"
    df = pd.read_sql_query(query, conn)
    conn.close()
    if not df.empty:
        fig = px.bar(df, x='node_id', y='value', title="Client Connections by Node", color_discrete_sequence=['teal'])
        fig.show()
```

## Capacity Forecast
```python
#| label: capacity-section
#| echo: false
#| output: asis

# Extract Rule 5.a Result
cap_res = next((r for r in results if r['id'] in ['5.a', '2.f']), None) 

if cap_res:
    display(Markdown(f"### {cap_res['name']}\n\n{cap_res['message']}"))
    if cap_res['status'] != "PASS":
        display(Markdown(f"\n**Recommendation:**\n{cap_res.get('remediation', '')}"))
else:
    display(Markdown("Capacity analysis not available."))
```

## Security Audit
```python
#| label: security-section
#| echo: false
#| output: asis

# Extract Rule 6.a Result
sec_res = next((r for r in results if r['id'] == '6.a'), None)
if sec_res:
    status_icon = "üîí" if sec_res['status'] == "PASS" else "‚ö†Ô∏è"
    display(Markdown(f"### {status_icon} {sec_res['name']}\n\n{sec_res['message']}"))
    if sec_res['status'] != "PASS":
        display(Markdown(f"\n**Remediation:**\n{sec_res.get('remediation', '')}"))
else:
    display(Markdown("Security audit telemetry not detected."))
```

# Observations and Remediation

```python
#| label: observations-remediation
#| echo: false
#| results: asis

actionable = [res for res in results if res['status'] != "PASS"]

if not actionable:
    display(Markdown("\n\n> ‚úÖ **All checks passed.** No critical issues detected.\n"))
else:
    for res in sorted(actionable, key=lambda x: x.get('id', '??')):
        remediation = res.get('remediation') or res.get('finding') or "Review telemetry."
        display(Markdown(f"### {res.get('id', '??')}: {res['name']}\n\n{res['message']}\n\n**Recommendation:** {remediation}\n\n---\n\n"))
```

# Appendix: All Tests Performed

```python
#| label: test-table
#| echo: false

# Create a clean list for the audit table
table_rows = []
for res in sorted(results, key=lambda x: x.get('id', '??')):
    status_icon = "‚úÖ" if res['status'] == "PASS" else "‚ùå" if res['status'] == "CRITICAL" else "‚ö†Ô∏è"
    table_rows.append({
        "ID": res.get('id', '??'),
        "Rule Name": res['name'],
        "Status": f"{status_icon} {res['status']}",
        "Evidence / Detail": res['message'] # This is the "Evidence" field
    })

# Render as a clean HTML table
display(HTML(pd.DataFrame(table_rows).to_html(index=False, escape=False, classes='table table-striped')))
```

---

::: {style="text-align: center; font-size: 0.8em; color: gray;"}
**Aerospike Health Analyzer** | Version: `{python} PROJECT_VERSION` | Generated: `{python} GEN_DATE`
:::