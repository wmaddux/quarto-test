---
title: "Aerospike Health and Performance Report"
author: "Aerospike TAM Team"
date: last-modified
format:
  html:
    toc: true
    theme: cosmo
    self-contained: true
---

```{python}
#| label: setup
#| include: false
import sqlite3
import pandas as pd
import plotly.express as px
import os
import datetime  # <--- Added this
from rules import delete_not_found_check, read_not_found_check, config_symmetry_check

# --- Baseline Metadata ---
PROJECT_VERSION = "1.1.0"
GEN_DATE = datetime.datetime.now().strftime("%Y-%m-%d %H:%M") # <--- Added this
db_path = "aerospike_health.db"

# Core Ruleset
results = [
    delete_not_found_check.run_check(db_path),
    read_not_found_check.run_check(db_path),
    config_symmetry_check.run_check(db_path)
]

# Summary Stats Logic
conn = sqlite3.connect(db_path)
# Note: Added a try/except or fillna to handle empty telemetry gracefully
try:
    dnf_query = "SELECT SUM(value) as total FROM namespace_stats WHERE metric = 'service.client_delete_not_found'"
    dnf_result = pd.read_sql_query(dnf_query, conn)
    dnf_val = dnf_result['total'].iloc[0] if not dnf_result.empty else 0
    
    node_query = "SELECT COUNT(DISTINCT node_id) as count FROM node_stats"
    node_count = pd.read_sql_query(node_query, conn)['count'].iloc[0]
except Exception as e:
    dnf_val = 0
    node_count = 0

conn.close()

formatted_dnf = "{:,}".format(int(dnf_val)) if dnf_val else "0"
```

# Executive Summary

This report provides a health assessment for the Aerospike cluster consisting of `{python} int(node_count)` nodes. Analysis identified **`{python} formatted_dnf`** "Delete Not Found" events, suggesting application-side logic gaps.

::: {.callout-note}
## TAM Overview
The cluster is stable, but high DNF rates indicate unnecessary IOPS pressure. Reviewing application "blind delete" patterns is the primary recommendation.
:::

## Cluster Status Overview
```{python}
#| label: cluster-overview
#| echo: false
#| output: asis

for res in results:
    if res['status'] in ['CRITICAL', 'WARNING']:
        status_style = "danger" if res['status'] == "CRITICAL" else "warning"
        print(f"::: {{.callout-{status_style}}}")
        print(f"## {res['name']}")
        print(f"{res['message']}")
        print(":::\n")
```

# Performance and Utilization

## Disk Usage % by Node

```{python}
#| label: disk-chart
#| echo: false
import sqlite3
import pandas as pd
import plotly.express as px

conn = sqlite3.connect(db_path)

# Querying the specific 7.2 namespace metric we verified exists
query = """
SELECT 
    node_id, 
    namespace,
    CAST(value AS FLOAT) as value 
FROM namespace_stats 
WHERE metric = 'service.data_used_pct'
"""
df = pd.read_sql_query(query, conn)
conn.close()

if not df.empty:
    fig = px.bar(
        df, 
        x='node_id', 
        y='value', 
        color='namespace',
        barmode='group',
        title="Disk Usage % by Node",
        labels={'value': 'Used %', 'node_id': 'Node', 'namespace': 'Namespace'},
        range_y=[0, 100],
        color_discrete_sequence=px.colors.qualitative.Bold
    )
    
    # Add High Water Mark Line (Aerospike default is often 60%)
    fig.add_hline(y=60, line_dash="dot", line_color="red", 
                 annotation_text="HWM (60%)", annotation_position="top left")
    
    fig.update_layout(yaxis_ticksuffix="%")
    fig.show()
else:
    print("::: {.callout-warning}")
    print("## Storage Metrics Missing")
    print("The metric 'service.data_used_pct' returned no rows. This can happen if the cluster is 'data-in-memory: true' without disk backing.")
    print(":::")
```

## Client Connections
```{python}
#| label: connections-chart
#| echo: false
conn = sqlite3.connect(db_path)
query = "SELECT node_id, value FROM node_stats WHERE metric = 'service.client_connections'"
df = pd.read_sql_query(query, conn)
conn.close()
if not df.empty:
    fig = px.bar(df, x='node_id', y='value', title="Client Connections by Node")
    fig.show()
```

# Observations and Remediation

```{python}
#| label: observations
#| echo: false
#| output: asis
for o in [r for r in results if r['status'] != 'PASS']:
    print(f"### {o['name']}")
    print(f"::: {{.callout-important}}")
    print(f"**Finding:** {o['message']}")
    if 'remediation' in o:
        print(f"\n**Recommendation:** {o['remediation']}")
    print(":::\n")
```

# Appendix: All Tests Performed
| Test Name | Status | Summary |
|-----------|--------|---------|
```{python}
#| label: test-table
#| echo: false
#| output: asis
for res in results:
    print(f"| {res['name']} | {res['status']} | {res['message']} |")
```

# TAM Technical Details

### Node Statistics (Sample)
```{python}
#| label: node-stats-table
#| echo: false
conn = sqlite3.connect(db_path)
df = pd.read_sql_query("SELECT node_id, metric, value FROM node_stats ORDER BY RANDOM() LIMIT 10", conn)
conn.close()
from IPython.display import display, HTML
display(HTML(df.to_html(index=False, classes='table table-striped')))
```
---

::: {style="text-align: center; font-size: 0.8em; color: gray;"}
**Aerospike Health Analyzer** | Version: `{python} PROJECT_VERSION` | Generated: `{python} GEN_DATE`
:::