---
title: "Aerospike Health and Performance Report"
author: "Aerospike TAM Team"
date: last-modified
format:
  html:
    toc: true
    theme: cosmo
    self-contained: true
---

```{python}
#| label: setup
#| include: false
import sqlite3
import pandas as pd
import plotly.express as px
import os
import datetime

# --- Import Reinstated Rules ---
from rules import (
    hot_key_check,
    service_error_skew_check,
    sindex_on_flash_check,
    sprig_limit_check,
    storage_deadlock_check,
    config_symmetry_check,
    read_not_found_check,
    delete_not_found_check,
    hwm_check,
    memory_hwm_check
)

# --- Baseline Metadata ---
PROJECT_VERSION = "1.2.0"
GEN_DATE = datetime.datetime.now().strftime("%Y-%m-%d %H:%M")
db_path = "aerospike_health.db"

# --- Execute Reinstated Ruleset ---
results = [
    hot_key_check.run_check(db_path),
    service_error_skew_check.run_check(db_path),
    sindex_on_flash_check.run_check(db_path),
    sprig_limit_check.run_check(db_path),
    storage_deadlock_check.run_check(db_path),
    config_symmetry_check.run_check(db_path),
    read_not_found_check.run_check(db_path),
    delete_not_found_check.run_check(db_path),
    hwm_check.run_check(db_path),
    memory_hwm_check.run_check(db_path)
]

# Summary Stats Logic
conn = sqlite3.connect(db_path)
# Note: Added a try/except or fillna to handle empty telemetry gracefully
try:
    dnf_query = "SELECT SUM(value) as total FROM namespace_stats WHERE metric = 'service.client_delete_not_found'"
    dnf_result = pd.read_sql_query(dnf_query, conn)
    dnf_val = dnf_result['total'].iloc[0] if not dnf_result.empty else 0
    
    node_query = "SELECT COUNT(DISTINCT node_id) as count FROM node_stats"
    node_count = pd.read_sql_query(node_query, conn)['count'].iloc[0]
except Exception as e:
    dnf_val = 0
    node_count = 0

conn.close()

formatted_dnf = "{:,}".format(int(dnf_val)) if dnf_val else "0"
```

# Executive Summary

This report provides a health assessment for the Aerospike cluster consisting of `{python} int(node_count)` nodes. Analysis identified **`{python} formatted_dnf`** "Delete Not Found" events, suggesting application-side logic gaps.

::: {.callout-note}
## TAM Overview
The cluster is stable, but high DNF rates indicate unnecessary IOPS pressure. Reviewing application "blind delete" patterns is the primary recommendation.
:::

## Cluster Status Overview
```{python}
#| label: cluster-overview
#| echo: false
#| output: asis

for res in results:
    if res['status'] in ['CRITICAL', 'WARNING']:
        status_style = "danger" if res['status'] == "CRITICAL" else "warning"
        print(f"::: {{.callout-{status_style}}}")
        print(f"## {res['name']}")
        print(f"{res['message']}")
        print(":::\n")
```

# Performance and Utilization

## Disk Usage % by Node

```{python}
#| label: disk-chart
#| echo: false
import sqlite3
import pandas as pd
import plotly.express as px

conn = sqlite3.connect(db_path)

# Querying the specific 7.2 namespace metric we verified exists
query = """
SELECT 
    node_id, 
    namespace,
    CAST(value AS FLOAT) as value 
FROM namespace_stats 
WHERE metric = 'service.data_used_pct'
"""
df = pd.read_sql_query(query, conn)
conn.close()

if not df.empty:
    fig = px.bar(
        df, 
        x='node_id', 
        y='value', 
        color='namespace',
        barmode='group',
        title="Disk Usage % by Node",
        labels={'value': 'Used %', 'node_id': 'Node', 'namespace': 'Namespace'},
        range_y=[0, 100],
        color_discrete_sequence=px.colors.qualitative.Bold
    )
    
    # Add High Water Mark Line (Aerospike default is often 60%)
    fig.add_hline(y=60, line_dash="dot", line_color="red", 
                 annotation_text="HWM (60%)", annotation_position="top left")
    
    fig.update_layout(yaxis_ticksuffix="%")
    fig.show()
else:
    print("::: {.callout-warning}")
    print("## Storage Metrics Missing")
    print("The metric 'service.data_used_pct' returned no rows. This can happen if the cluster is 'data-in-memory: true' without disk backing.")
    print(":::")
```

## Client Connections
```{python}
#| label: connections-chart
#| echo: false
conn = sqlite3.connect(db_path)
query = "SELECT node_id, value FROM node_stats WHERE metric = 'service.client_connections'"
df = pd.read_sql_query(query, conn)
conn.close()
if not df.empty:
    fig = px.bar(df, x='node_id', y='value', title="Client Connections by Node")
    fig.show()
```

# Observations and Remediation

```{python}
#| label: observations-remediation
#| echo: false
#| results: asis

from IPython.display import display, Markdown

# Filter for only actionable items
actionable = [res for res in results if res['status'] != "PASS"]

if not actionable:
    display(Markdown("\n\n> ✅ **All checks passed.** No critical issues detected in this snapshot.\n"))
else:
    # Build a single big markdown string
    md_output = ""
    for res in actionable:
        remediation = res.get('remediation', "Review cluster telemetry and application logs for further investigation.")
        
        md_output += f"### {res['name']}\n\n"
        md_output += f"{res['message']}\n\n"
        md_output += f"**Recommendation:** {remediation}\n\n"
        md_output += "---\n\n"
    
    # Display the final string as a single Markdown object
    display(Markdown(md_output))
```

# Appendix: All Tests Performed

```{python}
#| label: test-table
#| echo: false

import pandas as pd
from IPython.display import display, HTML

table_data = []
for res in results:
    # Clean up the name for the table (optional: remove the ID if you just want the name)
    clean_name = res['name'].split(":", 1)[-1].strip() if ":" in res['name'] else res['name']
    
    # Map status to the Emoji + Text format seen in your screenshots
    status_icon = "✅" if res['status'] == "PASS" else "❌" if res['status'] == "CRITICAL" else "⚠️"
    status_html = f"{status_icon} {res['status']}"
    
    table_data.append({
        "Check Name": clean_name,
        "Status": status_html
    })

df_app = pd.DataFrame(table_data)
# Applying 'table-hover' for that professional feel
display(HTML(df_app.to_html(index=False, escape=False, classes='table table-hover')))
```

# TAM Technical Details

### Node Statistics (Sample)
```{python}
#| label: node-stats-table
#| echo: false
conn = sqlite3.connect(db_path)
df = pd.read_sql_query("SELECT node_id, metric, value FROM node_stats ORDER BY RANDOM() LIMIT 10", conn)
conn.close()
from IPython.display import display, HTML
display(HTML(df.to_html(index=False, classes='table table-striped')))
```
---

::: {style="text-align: center; font-size: 0.8em; color: gray;"}
**Aerospike Health Analyzer** | Version: `{python} PROJECT_VERSION` | Generated: `{python} GEN_DATE`
:::