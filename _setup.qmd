#| label: setup
#| output: false
import sqlite3
import pandas as pd
import plotly.express as px
import os
import datetime
from IPython.display import display, Markdown, HTML
import sys

# --- Import Rules ---
from rules import (
    error_skew_check, 
    version_consistency_check,
    network_acceleration_check,
    storage_deadlock_check,
    sindex_on_flash_check,
    sprig_limit_check,
    hwm_check,
    memory_hwm_check,
    config_symmetry_check,
    config_drift_check,
    hot_key_check,
    read_not_found_check,
    delete_not_found_check,
    set_object_skew_check,
    capacity_check,
    security_connection_audit
)

# --- Baseline Metadata ---
PROJECT_VERSION = "1.6.0"
GEN_DATE = datetime.datetime.now().strftime("%Y-%m-%d %H:%M")
db_path = "aerospike_health.db"

# --- 1. Data Retrieval & Metadata ---
cluster_display = "Unnamed Cluster"
server_version = "Unknown"
node_count = 0
feature_list = []
active_features_str = "None detected"
cloud_platform = "Unknown"
consistency = "Unknown"
storage = "Unknown"
idx_type = "Unknown"
topology = "Unknown"

if os.path.exists(db_path):
    conn = sqlite3.connect(db_path)
    try:
        # 1. Base Metadata extraction
        meta_df = pd.read_sql_query("SELECT * FROM cluster_metadata", conn)
        metadata = dict(zip(meta_df['key'], meta_df['value']))

        cluster_display = metadata.get('cluster_name', "Unnamed Cluster")
        cloud_platform = metadata.get('cloud_platform', "Unknown")
        server_version = metadata.get('server_version', "Unknown")
        consistency = metadata.get('consistency_model', "Unknown")
        storage = metadata.get('storage_flavor', "Unknown")
        topology = metadata.get('topology', "Unknown")
        
       # --- NEW: Dynamic Index Location Lookup (Resilient) ---
        idx_type = metadata.get('index_flavor', "Unknown")
        if idx_type == "Unknown":
            # Check for All-Flash indicators (mounts)
            idx_res = pd.read_sql_query(
                "SELECT DISTINCT metric FROM namespace_stats WHERE metric LIKE 'service.index-type.mount%'", 
                conn
            )
            if not idx_res.empty:
                idx_type = "Flash (All-Flash)"
            else:
                # Fallback: If no mounts exist but index metrics do, it's standard RAM
                idx_type = "RAM (shmem)"
        # ------------------------------------------

        node_res = pd.read_sql_query("SELECT COUNT(DISTINCT node_id) as count FROM node_stats", conn)
        node_count = node_res['count'].iloc[0] if not node_res.empty else 0

        features_df = pd.read_sql_query("SELECT DISTINCT feature FROM active_features", conn)
        feature_list = sorted(features_df['feature'].tolist())
        active_features_str = ", ".join(feature_list) if feature_list else "None detected"

    except Exception as e:
        print(f"Error during metadata retrieval: {e}")
    finally:
        conn.close()

# --- 2. Execute Ruleset ---
results = [
    error_skew_check.run_check(db_path),
    version_consistency_check.run_check(db_path),
    network_acceleration_check.run_check(db_path),
    storage_deadlock_check.run_check(db_path),
    sindex_on_flash_check.run_check(db_path),
    sprig_limit_check.run_check(db_path),
    hwm_check.run_check(db_path),
    memory_hwm_check.run_check(db_path),
    config_symmetry_check.run_check(db_path),
    config_drift_check.run_check(db_path),
    hot_key_check.run_check(db_path),
    read_not_found_check.run_check(db_path),
    delete_not_found_check.run_check(db_path),
    set_object_skew_check.run_check(db_path),
    capacity_check.run_check(db_path),
    security_connection_audit.run_check(db_path)
]

# --- 3. Dynamic Narrative & Vitals Logic ---
# We count both WARNING and DATA MISSING as "warnings" to match the UI
crit_count = len([r for r in results if r.get('status') == 'CRITICAL'])
warn_count = len([r for r in results if r.get('status') in ['WARNING', '‚ö†Ô∏è DATA MISSING']])

if crit_count > 0:
    cluster_assessment = f"‚ö†Ô∏è This cluster requires **immediate intervention**. {crit_count} critical issues were detected." 
elif warn_count > 0:
    cluster_assessment = f"‚ö° The cluster is stable but showing signs of **resource pressure**. {warn_count} findings suggest optimization is required." 
else:
    cluster_assessment = "‚úÖ The cluster is currently **healthy and operating within optimal parameters**." 

# --- Updated Vitals Extraction in _setup.qmd ---

# 1. Capacity (5.a)
cap_vitals = next((r for r in results if r.get('id') == '5.a'), 
                  {'status': 'PASS', 'message': 'Resource utilization is nominal.'})

# 2. Security (6.a)
sec_vitals = next((r for r in results if r.get('id') == '6.a'), 
                  {'status': 'PASS', 'message': 'Security policies are active.'})

# 3. Configuration Integrity (1.a - Symmetry/Consistency)
# We search for Symmetry check to ensure the cluster is 'uniform'
sym_vitals = next((r for r in results if r.get('id') == '3.a'), 
                  {'status': 'PASS', 'message': 'Node configurations are synchronized.'})

def get_status_icon(status):
    if status == 'PASS': return "‚úÖ"
    if status == 'WARNING': return "‚ö†Ô∏è"
    if status == 'CRITICAL': return "üö®"
    return "‚ùì"

cap_icon = get_status_icon(cap_vitals['status'])
sec_icon = get_status_icon(sec_vitals['status'])
sym_icon = get_status_icon(sym_vitals['status'])

# Narrative Logic
is_sc = "Strong Consistency" in consistency
mode_name = "Strong Consistency (SC) deployment" if is_sc else "Available/Partition-tolerant (AP) deployment"
priority_text = "partition safety and transaction integrity" if is_sc else "throughput efficiency and resource headroom"

summary_narrative = (
    f"This diagnostic evaluates the **{cluster_display}** environment, currently running Aerospike **{server_version}** "
    f"across a **{node_count}-node** footprint. Optimized as a **{mode_name}**, the findings below prioritize "
    f"{priority_text}."
)

if topology == "XDR Enabled":
    summary_narrative += " Cross-Datacenter Replication (XDR) is active, adding requirements for inter-cluster bandwidth monitoring."